<!DOCTYPE html>
<html lang="en">
<head>
    <script src="http://jscolor.com/release/2.0/jscolor-2.0.4/jscolor.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script type="text/babel" >
        "use strict";
        let socket;
        
        let triangles = [];
        let lastColors = [];
        let highlightTri;
        let currentSwatches = [];
        
        let canvas;
        let ctx;
        let colorInput;
        let currentColor;
        let dragging = false;
        let linesOn = true;
        let eyedropperMode = false;

        let lastActions = [];
        let undoneActions = [];
        
        class Triangle {
            //Type 0 is a right facing triangle, type 1 is a left facing triangle
            constructor(x, y, type, id){
                this.x = x;
                this.y = y;
                this.type = type;
                this.color = "#ffffff";
                this.id = id;
                
                this.highlight = false;
                this.highlightColor = "#000000";
                
                //Create positions of vertices
                this.length1 = 40;
                this.length2 = 60;
                this.x1 = this.x;
                this.y1 = this.y;
                
                //set up other vertices based on length
                if(this.type == 0){
                    this.x2 = this.x1;
                    this.y2 = this.y1 + this.length1;
                    this.x3 = this.x1 + this.length2/2;
                    this.y3 = this.y1 + this.length1/2;
                }
                else{
                    this.x2 = this.x1 + this.length2/2;
                    this.y2 = this.y1 - this.length1/2;
                    this.x3 = this.x1 + this.length2/2;
                    this.y3 = this.y1 + this.length1/2;
                }
            }
            //Check if a point is inside the triangle
            containsPoint(posX, posY){
                //Point precheck
                if(posX > this.x+100 || posX < this.x-100 || posY > this.y+100 || posY < this.y-100 ){
                    return false;
                }
                
                const a = ((this.y2-this.y3)*(posX-this.x3) + (this.x3-this.x2)*(posY-this.y3)) / ((this.y2-this.y3)*(this.x1- this.x3) + (this.x3-this.x2)*(this.y1-this.y3));
                const b = ((this.y3-this.y1)*(posX-this.x3) + (this.x1-this.x3)*(posY-this.y3)) / ((this.y2-this.y3)*(this.x1-this.x3) + (this.x3-this.x2)*(this.y1-this.y3));
                const c = 1 - a - b;
      
                return (0<=a) && (a<=1) && (0<=b) && (b<=1) && (0<=c) && (c<=1);
            }
            draw(linesOn){
                ctx.save();
                if(this.highlight){
                    ctx.fillStyle = this.highlightColor;
                }
                else{
                    ctx.fillStyle = this.color;
                }
                
                ctx.beginPath();
                ctx.moveTo(this.x1, this.y1);
                ctx.lineTo(this.x2, this.y2);
                ctx.lineTo(this.x3, this.y3);
                ctx.fill();
                ctx.closePath();
                if(linesOn) {
                    ctx.stroke();
                }
                
                ctx.restore();
            }
            highlightOn(highlightColor){
                this.highlight = true;
                this.highlightColor = highlightColor;
            }
            highlightOff(){
                this.highlight = false;
            }
            setColor(newColor){
                this.color = newColor;
            }
            getColor(){
                return this.color;
            }
        };

        const updateSwatches = (swatches) => {
            
        }
        var testTri = new Triangle(30,30,0);
        
        const init = (e) => {
            canvas = document.querySelector('canvas');
            ctx = canvas.getContext('2d');
            
            const join = document.querySelector("#join");
            join.addEventListener('click', checkJoinRoom);
            
            const create = document.querySelector("#create");
            create.addEventListener('click', checkCreateRoom);
            
            socket = io.connect();
            setupSocket();
            //setupTriangles();
            //updateColor();
            
        };
        window.onload = init;
        
        const updateColor = () => {
            if(eyedropperMode) toggleEyedropper();
            
            currentColor = "#"+colorInput.jscolor;
            var originalColor = colorInput.jscolor;
            
            //var shadowBtn = document.getElementById('shadow-btn');
           // shadowBtn = 
            
            var shadowSwatch = colorInput.jscolor;
            
            
            //Decrease hue
            var hue = shadowSwatch.hsv[0] - 5;
            if(hue < 0) hue = 0;
            
            //Saturation stays the same
            var saturation = shadowSwatch.hsv[1];
            
            //Decrease value
            var value = shadowSwatch.hsv[2] - 15;
            if(value < 0) value = 0;
            shadowSwatch.fromHSV(hue, saturation, value);
            
            document.getElementById('shadow').value = shadowSwatch.toHEXString();
            document.getElementById('shadow').style.backgroundColor = shadowSwatch.toHEXString();
            colorInput.jscolor.fromString(currentColor);
    
            
            //Create Highlight swatch
            var highlightSwatch = colorInput.jscolor;
            
            //Increase hue
            hue = highlightSwatch.hsv[0] + 5;
            if(hue > 360) hue = 360;
            
            //Decrease saturation
            saturation = highlightSwatch.hsv[1] - 5;
            if(saturation < 0) saturation = 0;
            
            //Increase value
            value = highlightSwatch.hsv[2] + 15;
            if(value > 100) value = 100;
            highlightSwatch.fromHSV(hue, saturation, value);
            
            document.getElementById('highlight').value = highlightSwatch.toHEXString();
            document.getElementById('highlight').style.backgroundColor = highlightSwatch.toHEXString();
            colorInput.jscolor.fromString(currentColor);

            
            socket.emit("addSwatch", {newColor: currentColor});
        };
        
        const toggleLines = () => {
            linesOn = !linesOn;
            
            //Redraw all triangles
            drawAll();
        };

        const toggleEyedropper = () => {
            eyedropperMode = !eyedropperMode;
            if(eyedropperMode) {
                canvas.style.cursor = "copy";
            }
            else {
               canvas.style.cursor = "default"; 
            }
        }
        
        const undoAction = () => {
            //var lastAction = lastActions.pop();
            //undoneActions.push(lastAction);
            //update(lastAction);
            
            
            let testTris = triangles;
            for(var i = 0; i < triangles.length; i++){
                testTris[i].setColor('#ff000f');
            }
            
            socket.emit("undoAction", {testTri: testTris});
        }
        
        const redoAction = () => {
            
        }
        
        const clearCanvas = () => {
            for(var i = 0; i < triangles.length; i++){
                triangles[i].setColor('#ffffff');
            }
            update(triangles);
            drawAll();
        }
        
        const saveCanvas = () => {
            var image = canvas.toDataURL("image/png");
			window.open(image);
        }
        
        const handleMessage = (data) => {
            //Update canvas using the new data (the other user's array)
            //Fill triangles in with new colors
            let changedTriangles = [];
            
            
            for(var i = 0; i < data.triangles.length; i++){
                triangles[data.triangles[i].id].setColor(data.triangles[i].color);
                changedTriangles.push(triangles[data.triangles[i].id]);
            }
            drawChanged(changedTriangles);
        };
        
        const setupSocket = (e) => {
             socket.on('connect', () => {
                socket.emit('join', null);
            });
            socket.on('joinRoom', (data) => {
                setupCanvas();
				socket.roomName = data.roomName;
            });
            socket.on('denyRoom', (data) => {
                let errorText = document.querySelector("#error-text");
                errorText.innerHTML = data.message;
            });

        };

        const setupCanvas = (e) => {
            canvas = document.querySelector('canvas');
            ctx = canvas.getContext('2d');
            
            canvas.onmousedown = onMouseDown;
            canvas.onmouseup = onMouseUp;
            canvas.onmousemove = onMouseMove;
            canvas.onmouseout = onMouseOut;
            
            colorInput = document.getElementById('color-input');
            colorInput.addEventListener("change",updateColor);
            currentColor = "#"+colorInput.jscolor;
            
            var linesBtn = document.getElementById('lines-toggle');
            linesBtn.addEventListener("click",toggleLines);
            
            var saveBtn = document.getElementById('save-btn');
            saveBtn.addEventListener("click",saveCanvas);
            
            var clearBtn = document.getElementById('clear-btn');
            clearBtn.addEventListener("click",clearCanvas);
            
            var eyedropperBtn = document.getElementById('eyedropper-btn');
            eyedropperBtn.addEventListener("click",toggleEyedropper);
            
            var undoBtn = document.getElementById('undo-btn');
            undoBtn.addEventListener("click",undoAction);
            
            var redoBtn = document.getElementById('redo-btn');
            redoBtn.addEventListener("click",redoAction);
            
            var shadowSwatch = document.getElementById('shadow');
            shadowSwatch.addEventListener("click",function(){
                colorInput.jscolor.fromString(this.value);
                updateColor();
            });
            
            var highlightSwatch = document.getElementById('highlight');
            highlightSwatch.addEventListener("click",function(){
                colorInput.jscolor.fromString(this.value);
                updateColor();
            });
            
            for(var i = 0; i < 8; i++){
                var swatch = document.getElementById('swatch-box'+i);
                
                swatch.addEventListener("click",function(){
                    colorInput.jscolor.fromString(this.value);
                    updateColor();
                });
            }
            
            socket.on('updateCanvas', (data) => {
                handleMessage(data);
            });
            socket.on('setupFirstCanvas', (data) => {
               clearCanvas();
               socket.emit("updateTriangles", {triangles: triangles});
            });
            socket.on('updateSwatches', (data) => {
               for(var i = 0; i < data.swatches.length; i++){
                   var swatch = document.getElementById('swatch-box'+i);
                   swatch.value = data.swatches[i];
                   swatch.style.backgroundColor = data.swatches[i];
               }
            });
            
            setupTriangles();
            updateColor();
            socket.emit("initializeTriangles", null);
            document.getElementById('creation-container').style.display = 'none';
            document.getElementById('paint-container').style.display = 'block';
        };

        const setupTriangles = (e) => {
            //create the array of triangles
            //populate array with right facing triangles
            var idNum = 0;
            var posX = 0;
            var posY = 0; 
            var rowTrigger = true;
            
            while(posX<=canvas.width){
                while(posY<=canvas.height){  
                    triangles.push(new Triangle(posX,posY,0,idNum));
                    idNum++;
                    posY+= 39;
                }
                posX+=30;
              
                if(rowTrigger){
                    posY=-20;}
                 else{
                    posY = 0;
                }
               rowTrigger = !rowTrigger;
            }
            
            //Populate array with left facing triangles
            rowTrigger = true;
            posX = 0;
            posY = 0; 
            while(posX<=canvas.width){
                while(posY<=canvas.height){  
                    triangles.push(new Triangle(posX,posY,1,idNum));
                    idNum++;
                    posY+= 39;
                }
                posX+=30;
              
                if(rowTrigger){
                    posY=-20;}
                else{
                    posY = 0;
                }
               rowTrigger = !rowTrigger;
            }
            for(var i = 0; i < triangles.length; i++){
                lastColors[i] = triangles[i].color;
            }
            
            highlightTri = triangles[0];
            
        };

        const checkJoinRoom = () => {
            let roomInput = document.querySelector("#room-input").value;
            socket.emit('checkJoin', { roomName: roomInput });
        }
        const checkCreateRoom = () => {
            let roomInput = document.querySelector("#room-input").value;
            socket.emit('checkCreate', { roomName: roomInput });
        }
        
        const onMouseDown = (e) => {
            var mouse = {};
            mouse.x = e.pageX - e.target.offsetLeft;
            mouse.y = e.pageY - e.target.offsetTop;
            
            dragging = true;
            
            var changedTriangles = [];
            
            //Check if mouse is in triangles
            for(var i = 0; i < triangles.length; i++){
                if(triangles[i].containsPoint(mouse.x, mouse.y)){ 
                    if(eyedropperMode){
                        console.log(triangles[i].getColor());
                        var colorString = triangles[i].getColor().slice(1);
                        colorInput.jscolor.fromString(colorString);
                        updateColor();
                    }
                    triangles[i].setColor(currentColor);
                    changedTriangles.push(triangles[i]);
                    socket.emit("pushAction", {triangles: changedTriangles});
                }
            }
            
            if(changedTriangles.length != 0) update(changedTriangles);
        };
        const onMouseUp = (e) => {
            dragging = false;
        };
        const onMouseOut = (e) => {
            dragging = false;
            highlightTri.highlightOff();
            update([highlightTri]);
        };
        const onMouseMove = (e) => {
            if(!eyedropperMode){
                var mouse = {};
                mouse.x = e.pageX - e.target.offsetLeft;
                mouse.y = e.pageY - e.target.offsetTop;

                var changedTriangles = [];

                //check if mouse is in triangles
                for(var i = 0; i < triangles.length; i++){
                    if(triangles[i].containsPoint(mouse.x, mouse.y)){ 
                        if(dragging){
                            triangles[i].setColor(currentColor);
                            changedTriangles.push(triangles[i]);
                            socket.emit("pushAction", {triangles: changedTriangles});
                        }
                        else{
                            if(triangles[i].id != highlightTri.id){
                                //Turn the highlight for the current triangle on
                                triangles[i].highlightOn(currentColor);
                                changedTriangles.push(triangles[i]);

                                //Turn the highlight for the last triangle off
                                highlightTri.highlightOff();
                                changedTriangles.push(highlightTri);

                                //Update hightlighted tri
                                highlightTri = triangles[i];
                            }
                        }
                    }
                }
                
                if(changedTriangles.length != 0) update(changedTriangles);
            }
            
        };
        
        const update = (changedTriangles) => {
        //update is called after a triangle is interacted with
            //send the server the array of triangles
            socket.emit("draw", {triangles: changedTriangles});
        };
        
        const drawAll = (e) => {
            for(var i = 0; i < triangles.length; i++){
                triangles[i].draw(linesOn);   
            }
        };
        const drawChanged = (changedTriangles) => {
            
            for(var i = 0; i < changedTriangles.length; i++){
                changedTriangles[i].draw(linesOn);
            }

        };
        
        
        
    
    </script>
    
</head>
<body>
    <div id="creation-container" style="float:right;">
        <label for="room-name">Room Name:</label>
        <input id="room-input" name="room-name" type="text" />
        <input type="button" id="join" value='Join Room'/>
        <input type="button" id="create" value='Create Room'/>
        <p id="error-text" style="color: #bf1e1e"></p>
    </div>
    
    <div id = "paint-container" style="display:none;">
        <canvas width="1000" height="645" style="cursor: default; ">
            Your browser does not support Canvas
        </canvas>
        
        <div id="controls">
            <p>
                <input id="lines-toggle" type="button" value="Toggle Lines">
            </p>
            <p>
                <input id="clear-btn" type="button" value="Clear">
            </p>
            <p>
                <input id="save-btn" type="button" value="Save">
            </p>
            <p>
                <input id="undo-btn" type="button" value="Undo">
                <input id="redo-btn" type="button" value="Redo">
            </p>
            <p>
                <input id="eyedropper-btn" type="button" value="Pick Color">
            </p>
                <div id="swatches">
                    <button id="swatch-box0" value="#ffffff" style="width: 25px; height:25px; background-color:white;"></button>
                    <button id="swatch-box1" value="#ffffff" style="width: 25px; height:25px; background-color:white;"></button>
                    <button id="swatch-box2" value="#ffffff" style="width: 25px; height:25px; background-color:white;"></button>
                    <button id="swatch-box3" value="#ffffff" style="width: 25px; height:25px; background-color:white;"></button>
                    <button id="swatch-box4" value="#ffffff" style="width: 25px; height:25px; background-color:white;"></button>
                    <button id="swatch-box5" value="#ffffff" style="width: 25px; height:25px; background-color:white;"></button>
                    <button id="swatch-box6" value="#ffffff" style="width: 25px; height:25px; background-color:white;"></button>
                    <button id="swatch-box7" value="#ffffff" style="width: 25px; height:25px; background-color:white;"></button>

                </div>

            <p>
                <button id="highlight" style="width: 25px; height:25px; background-color:white;"></button>
                <input type="button" id="color-input" class="jscolor {closable:true,closeText:'Close'}" value="cc66ff" style="width:50px; height:20px;">
                <button id="shadow" style="width: 25px; height:25px; background-color:black;"></button>
            </p>
        </div>
    </div>
</body>
</html>